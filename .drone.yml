kind: pipeline
type: docker
name: integration

steps:
  - name: fix_permissions
    image: node:16
    commands:
      - chown -R 1000:1000 /drone/src

  - name: kode-analyse
    image: sonarsource/sonar-scanner-cli:latest
    commands:
      - sonar-scanner -Dsonar.projectKey=easv-devops_UndercoverSpillet_AY_JUDVyEVvRW2O60GX5 -Dsonar.sources=. -Dsonar.host.url=http://sonar.setgo.dk:9000 -Dsonar.login=$SONAR_TOKEN
    environment:
      SONAR_TOKEN:
        from_secret: sonarqube_token

  - name: make_tests_executable
    image: node:16
    commands:
      - chmod +x test/unit/.test.cjs

  - name: install_dependencies
    image: node:16
    commands:
      - npm install
    environment:
      DRONE_DEBUG: true
    timeout: 10m
    resources:
      limits:
        memory: 2GiB
        cpu: 2

  - name: test_unit
    image: node:16
    commands:
      - npm run test:unit
    environment:
      DRONE_DEBUG: true
    timeout: 10m
    resources:
      limits:
        memory: 2GiB
        cpu: 2

  - name: lint
    image: node:16
    commands:
      - npm install eslint eslint-plugin-import eslint-plugin-node eslint-config-airbnb-base --save-dev
      - chmod +x ./node_modules/.bin/eslint
      - npm run lint -- --max-warnings 10 || true
    environment:
      DRONE_DEBUG: true
    timeout: 5m
    resources:
      limits:
        memory: 1GiB
        cpu: 1

---

kind: pipeline
type: docker
name: deliver

steps:
  # Wait for MongoDB to be ready
  - name: wait_for_mongodb
    image: mvertes/alpine-mongo
    commands:
      - >
        until mongo "mongodb+srv://yonesswaidan:sgg59mcd@game-database.x2asuuz.mongodb.net/game-database" --eval "print('waited for connection')" || sleep 2; do :; done

  # Start the Node.js server and run load test
  - name: start_server_og_load_test
    image: node:16
    commands:
      - npm install
      - apt-get update && apt-get install -y wget
      - wget -q -O - https://dl.k6.io/key.gpg | apt-key add -
      - echo "deb https://dl.k6.io/deb stable main" | tee -a /etc/apt/sources.list
      - apt-get update && apt-get install -y k6
      - node server.js &  # Start serveren i baggrunden
      - sleep 5  # Vent 5 sekunder for at sikre, at serveren starter
      - k6 run load_test.js  # Kør load testen
    environment:
      MONGO_URI: mongodb+srv://yonesswaidan:sgg59mcd@game-database.x2asuuz.mongodb.net/game-database
      PORT: 3000
      DRONE_DEBUG: true
    timeout: 20m
    resources:
      limits:
        memory: 2GiB
        cpu: 2
    depends_on:
      - wait_for_mongodb

  - name: publish_api
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      context: .  # Sørg for at konteksten er sat til projektets rodmappe
      dockerfile: Dockerfile
      repo: yonesswaidan/undercovergame-api
      tags: staging

  - name: publish_web
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      context: .  # Sørg for at konteksten er sat til projektets rodmappe
      dockerfile: Dockerfile
      repo: yonesswaidan/undercovergame-web
      tags:
        - staging

---

kind: pipeline
type: docker
name: deploy

steps:
  - name: release_api
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      context: .  # Sørg for at konteksten er sat til projektets rodmappe
      dockerfile: Dockerfile
      repo: yonesswaidan/undercovergame-api
      tags:
        - delivery

  - name: release_web
    image: plugins/docker
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      context: .  # Sørg for at konteksten er sat til projektets rodmapp
      dockerfile: Dockerfile
      repo: yonesswaidan/undercovergame-web
      tags:
        - delivery

services:
  - name: mongodb
    image: mongo
    environment:
      MONGO_INITDB_DATABASE: game-database

secrets:
  - name: docker_username
  - name: docker_password
  - name: sonarqube_token
